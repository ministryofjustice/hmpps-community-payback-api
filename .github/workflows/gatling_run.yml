name: Gatling performance test run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Which API should this run against"
        required: false
        default: "dev"
        options:
          - dev
          - test
      simulationFqn:
        description: "Optional fully-qualified simulation class to run (e.g. uk.gov.justice.digital.hmpps.communitypayback.simulations.SomeSimulation)"
        required: false
        default: ""
        options:
          - ""
          - uk.gov.justice.digital.hmpps.communitypayback.stories.ui.E2E
          - uk.gov.justice.digital.hmpps.communitypayback.simulations.HealthSimulation
          - "uk.gov.justice.digital.hmpps.communitypayback.simulations.ProviderSimulation"
          - "uk.gov.justice.digital.hmpps.communitypayback.simulations.ReferenceSimulation"
      nothingFor:
        description: "How long to wait before starting the onslaught"
        required: false
        default: "5"
      atOnceUsers:
        description: "Number of initial concurrent users"
        required: false
        default: "10"
      rampUsers:
        description: "How many users to increase to over time"
        required: false
        default: "50"
      rampUsersDuring:
        description: "Number of seconds over which to increase the user count"
        required: false
        default: "30"
      constantUsersPerSec:
        description: "The number of concurrent users to keep active per second"
        required: false
        default: "10.0"
      constantUsersPerSecDuring:
        description: "The time period in seconds over which peak load should be applied"
        required: false
        default: "60"

jobs:
  gatling-run:
    name: Run Gatling simulations
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    timeout-minutes: 60

    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Touch env file
        run: touch ./gatling/.env

      - name: Start Gatling
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: |
          set -euo pipefail
          ARGS=("--no-daemon")
          ARGS+=("--stacktrace")
          ARGS+=("gatlingRunCi")

          # Pass all workflow inputs as Gradle properties
          if [ -n "${{ inputs.simulationFqn }}" ]; then
            ARGS+=("-PsimulationFqn=${{ inputs.simulationFqn }}")
          fi
          ARGS+=("-PnothingFor=${{ inputs.nothingFor }}")
          ARGS+=("-PatOnceUsers=${{ inputs.atOnceUsers }}")
          ARGS+=("-PrampUsers=${{ inputs.rampUsers }}")
          ARGS+=("-PrampUsersDuring=${{ inputs.rampUsersDuring }}")
          ARGS+=("-PconstantUsersPerSec=${{ inputs.constantUsersPerSec }}")
          ARGS+=("-PconstantUsersPerSecDuring=${{ inputs.constantUsersPerSecDuring }}")
          ARGS+=("-Penvironment=${{ inputs.environment }}")
          ARGS+=("-PCLIENT_ID=${{ secrets.CLIENT_ID }}")
          ARGS+=("-PCLIENT_SECRET=${{ secrets.CLIENT_SECRET }}")

          echo "Running: ./gradlew ${ARGS[*]}"
          ./gradlew "${ARGS[@]}"

      - name: Upload Gatling reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gatling-reports
          path: |
            gatling/build/reports/gatling/**
            **/build/reports/gatling/**
          if-no-files-found: warn