name: Gatling performance test run

on:
  workflow_dispatch:
    inputs:
      simulation:
        description: "Optional fully-qualified simulation class to run (e.g. uk.gov.justice.digital.hmpps.communitypayback.simulations.SomeSimulation)"
        required: false
        default: ""
        options:
          - ""
          - uk.gov.justice.digital.hmpps.communitypayback.stories.ui.E2E
          - uk.gov.justice.digital.hmpps.communitypayback.simulations.HealthSimulation
          - "uk.gov.justice.digital.hmpps.communitypayback.simulations.ProviderSimulation"
          - "uk.gov.justice.digital.hmpps.communitypayback.simulations.ReferenceSimulation"
      NOTHING_FOR:
        description: "Optional extra Gradle args (e.g. -Pusers=10 -Pduration=60)"
        required: false
        default: 5
      AT_ONCE_USERS:
        description: "Optional extra Gradle args (e.g. -Pusers=10 -Pduration=60)"
        required: false
        default: 10
      RAMP_USERS:
        description: "Optional extra Gradle args (e.g. -Pusers=10 -Pduration=60)"
        required: false
        default: 50
      RAMP_USERS_DURING:
        description: "Optional extra Gradle args (e.g. -Pusers=10 -Pduration=60)"
        required: false
        default: 30
      CONSTANT_USERS_PER_SEC:
        description: "Optional extra Gradle args (e.g. -Pusers=10 -Pduration=60)"
        required: false
        default: 10.0
      CONSTANT_USERS_PER_SEC_DURING:
        description: "Optional extra Gradle args (e.g. -Pusers=10 -Pduration=60)"
        required: false
        default: 60

jobs:
  gatling-run:
    name: Run Gatling simulations
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Touch env file
        run: touch ./gatling/.env

      - name: Run Gatling
        run: |
          set -euo pipefail
          ARGS=("--no-daemon")
          ARGS+=("--stacktrace")
          ARGS+=("gatlingRun")

          # Add simulation class if provided
          if [ -n "${{ inputs.simulation }}" ]; then
            ARGS+=("-Pgatling.simulation=${{ inputs.simulation }}")
          else
            ARGS+=("--all")
          fi

          # Add Gatling properties from inputs
          ARGS+=("-PNOTHING_FOR=${{ inputs.NOTHING_FOR }}")
          ARGS+=("-PAT_ONCE_USERS=${{ inputs.AT_ONCE_USERS }}")
          ARGS+=("-PRAMP_USERS=${{ inputs.RAMP_USERS }}")
          ARGS+=("-PRAMP_USERS_DURING=${{ inputs.RAMP_USERS_DURING }}")
          ARGS+=("-PCONSTANT_USERS_PER_SEC=${{ inputs.CONSTANT_USERS_PER_SEC }}")
          ARGS+=("-PCONSTANT_USERS_PER_SEC_DURING=${{ inputs.CONSTANT_USERS_PER_SEC_DURING }}")

          echo "Running: ./gradlew ${ARGS[*]}"
          ./gradlew "${ARGS[@]}"

      - name: Upload Gatling reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gatling-reports
          path: |
            gatling/build/reports/gatling/**
            **/build/reports/gatling/**
          if-no-files-found: warn
